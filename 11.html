<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกกิจกรรม (แก้ไขแล้ว)</title>
    
    <!-- เพิ่มไลบรารีสำหรับการส่งออก -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        /* CSS styles - ปรับปรุงให้คล้ายกับไฟล์ index.html */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 95%;
        }

        /* ปรับปรุง header ให้คล้ายกับไฟล์ index.html */
        header {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        header h1, .container h1 {
            color: #0056b3;
            margin: 0;
            font-size: 1.8em;
            text-align: center;
        }

        #main-nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        #main-nav a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            padding: 10px 15px;
            border-radius: 20px;
            transition: background-color 0.3s;
            border: 2px solid #007bff;
            background-color: white;
            text-align: center;
            flex: 1;
            min-width: 150px;
            max-width: 200px;
        }

        #main-nav a:hover {
            background-color: #e2e6ea;
        }

        #main-nav a.active {
            background-color: #007bff;
            color: white;
        }

        #logout-button {
            background-color: #E97132;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin-top: 10px;
            width: 100%;
            max-width: 200px;
            align-self: center;
        }

        #logout-button:hover {
            background-color: #e64a19;
        }

        button, .button-group button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin-right: 5px;
            width: 100%;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        button:hover, .button-group button:hover {
            background-color: #0056b3;
        }

        button:disabled, .button-group button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .form-section, .data-section {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }

        h2 {
            color: #0056b3;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
            text-align: center;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        input[type="text"],
        input[type="password"],
        input[type="date"],
        input[type="time"],
        select {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 20px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
            text-align: center;
        }
        
        textarea {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 20px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
            resize: vertical;
            text-align: center;
        }

        label {
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
        }

        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
        }

        .filter-controls input, .filter-controls button, .filter-controls select {
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
            min-width: 120px;
            flex: 1;
            max-width: 200px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th, table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            word-break: break-word;
        }

        table th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }

        table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        table tr:hover {
            background-color: #e9e9e9;
        }

        .action-buttons button {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            padding: 5px 10px;
            font-size: 0.9em;
            transition: color 0.3s;
            border-radius: 15px;
            margin: 2px;
        }

        .action-buttons button:hover {
            color: #0056b3;
            background-color: #f0f0f0;
        }

        .action-buttons .delete-button {
            color: #dc3545;
        }
        .action-buttons .delete-button:hover {
            color: #bd2130;
            background-color: #f8d7da;
        }

        .hidden {
            display: none !important;
        }

        .error-message {
            color: red;
            margin-top: 10px;
            font-weight: bold;
            text-align: center;
        }

        .success-message {
            color: green;
            margin-top: 10px;
            font-weight: bold;
            text-align: center;
        }

        #timer-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
            margin-top: 10px;
            text-align: center;
            display: block;
        }

        .info-message {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 10px;
            text-align: center;
        }
        
        /* Navigation for logged out state */
        #main-nav {
            display: none;
        }

        .summary-block {
            background-color: #eaf6ff;
            border-left: 5px solid #007bff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .summary-block h4 {
            margin-top: 0;
            color: #0056b3;
        }
        .summary-block ul {
            list-style-type: none;
            padding: 0;
        }
        .summary-block li {
            margin-bottom: 5px;
        }
        .summary-total {
            font-weight: bold;
            color: #28a745;
            font-size: 1.1em;
            margin-top: 10px;
            display: block;
        }
        
        /* New styles for password toggle */
        .password-container {
            position: relative;
            width: 100%;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
        }
        
        .password-toggle:hover {
            color: #333;
        }
        
        /* Modal styles for user management */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .modal-title {
            margin: 0;
            color: #0056b3;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }
        
        .close-modal:hover {
            color: #333;
        }

        /* เพิ่มสไตล์สำหรับ Modal ใหม่ */
        .modal-overlay { 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.6);
            display: none; 
            justify-content: center; 
            align-items: center; 
            padding: 10px;
            overflow-y: auto; 
        }
        
        .format-modal-content {
            background-color: #fff;
            padding: 20px 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
        }

        .format-modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .format-modal-buttons button {
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
        }

        .format-modal-buttons .btn-display { 
            background-color: #007bff; 
        }
        .format-modal-buttons .btn-display:hover { 
            background-color: #0056b3; 
        }
        
        .format-modal-buttons .btn-xlsx { 
            background-color: #107C41; 
        }
        .format-modal-buttons .btn-xlsx:hover { 
            background-color: #0E6A37; 
        }
        
        .format-modal-buttons .btn-pdf { 
            background-color: #e64a19; 
        }
        .format-modal-buttons .btn-pdf:hover { 
            background-color: #bf360c; 
        }
        
        .format-modal-buttons .btn-cancel { 
            background-color: #6c757d; 
            margin-top: 10px;
        }
        .format-modal-buttons .btn-cancel:hover { 
            background-color: #5a6268; 
        }

        /* === START: CSS ใหม่สำหรับ Modal แสดงสรุป === */
        .summary-modal-overlay {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow-y: auto;
        }

        .summary-modal-content-container {
            background-color: #FAFAD2;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: auto 0;
            width: 100%;
            max-width: 800px;
        }

        .summary-modal-close-btn {
            background-color: #E97132;
            color: white;
            padding: 12px 30px;
            border: none;
            cursor: pointer;
            border-radius: 20px;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color 0.3s;
            width: 90%;
            max-width: 250px;
        }

        .summary-modal-close-btn:hover {
            background-color: #e64a19;
        }

        .summary-modal-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-top: 10px;
            max-width: 600px;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
        }

        .summary-control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: 15px;
        }

        .summary-control-group label, .summary-control-group span {
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
        }

        .summary-control-group input[type="range"] {
            width: 80%;
            max-width: 300px;
            margin: 0;
        }

        /* === START: REVISED PRINT STYLES === */
        @media screen {
            #print-container {
                display: none;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #print-container, #print-container * {
                visibility: visible;
            }
            #print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 0 5mm;
            }
            
            @page {
                size: A4;
                margin: 15mm 5mm 10mm 10mm; /* top, right, bottom, left */
                @top-center {
                    content: "หน้า " counter(page);
                    font-family: Arial, sans-serif;
                    font-size: 9pt;
                    color: #888;
                    margin-top: 5mm;
                }
            }
            body {
                background: #fff !important;
                font-size: 10pt;
                margin: 0;
                width: 100%;
            }
            
            #print-container .summaryResult {
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                background-color: #fff !important;
                text-align: center;
                width: 100% !important;
                max-width: 100% !important;
                margin-top: 10mm; /* เพิ่ม margin-top เพื่อเว้นที่สำหรับเลขหน้า */
            }
            
            #print-container .summaryResult p[style*="margin-left"] {
                text-align: left;
                display: inline-block;
            }
            
            #print-container h2, #print-container h3, #print-container h4 {
                margin-bottom: 0.5em;
            }
            #print-container p, #print-container li {
                font-size: 9.5pt;
                line-height: 1.0;
            }
            #print-container table {
                width: 100% !important;
                border-collapse: collapse !important;
                font-size: 9pt;
                margin-top: 0.8em;
                page-break-inside: auto;
            }
            #print-container thead {
                 display: table-header-group;
            }
            #print-container tr {
                page-break-inside: avoid;
            }
            #print-container th, #print-container td {
                border: 1px solid #888 !important;
                padding: 4px 6px;
                text-align: center;
                line-height: 1.2; 
            }
            #print-container th {
                background-color: #f0f0f0 !important;
                font-weight: bold;
            }
            #print-container span[style*="color"] {
                color: #000 !important;
            }
            #print-container hr {
                 border-top: 1px solid #999;
                 margin: 1.5em 0;
            }
        }
        /* === END: REVISED PRINT STYLES === */

        /* === END: CSS ใหม่สำหรับ Modal แสดงสรุป === */

        /* === START: ปรับปรุงสำหรับมือถือ === */
        @media screen and (max-width: 768px) {
            .container {
                padding: 10px;
                margin: 10px auto;
            }
            
            header h1, .container h1 {
                font-size: 1.5em;
            }
            
            #main-nav {
                flex-direction: column;
                align-items: center;
            }
            
            #main-nav a {
                width: 100%;
                max-width: 100%;
                margin-bottom: 5px;
            }
            
            .button-group, .filter-controls {
                flex-direction: column;
            }
            
            .button-group button, .filter-controls button, .filter-controls input, .filter-controls select {
                width: 100%;
                max-width: 100%;
            }
            
            table {
                font-size: 0.9em;
            }
            
            table th, table td {
                padding: 8px 5px;
            }
            
            .form-section, .data-section {
                padding: 15px;
            }
            
            .modal-content, .format-modal-content, .summary-modal-content-container {
                width: 95%;
                padding: 15px;
            }
        }

        @media screen and (max-width: 480px) {
            header h1, .container h1 {
                font-size: 1.3em;
            }
            
            h2 {
                font-size: 1.2em;
            }
            
            table {
                font-size: 0.8em;
            }
            
            table th, table td {
                padding: 5px 3px;
            }
            
            .action-buttons button {
                padding: 3px 6px;
                font-size: 0.8em;
            }
        }
        /* === END: ปรับปรุงสำหรับมือถือ === */
    </style>
</head>
<body>
    <div class="container">
        <!-- Header for logged in users -->
        <header id="main-header" class="hidden">
            <h1 id="welcome-message">ยินดีต้อนรับ, ผู้ใช้งาน!</h1>
            <nav id="main-nav">
                <a href="#" data-page="activity" class="active">บันทึกกิจกรรม</a>
                <a href="#" data-page="activity-types">จัดการประเภทกิจกรรม</a>
                <a href="#" data-page="summary">สรุปกิจกรรมรายวัน</a>
                <a href="#" data-page="admin" id="admin-link" class="hidden">Admin Dashboard</a>
                <button id="logout-button">ออกจากระบบ</button>
            </nav>
        </header>

        <!-- Login/Register Section -->
        <div id="auth-section">
            <h1>ระบบบันทึกกิจกรรม</h1>
            
            <div class="form-section" id="login-section">
                <h2>เข้าสู่ระบบ</h2>
                <form id="login-form">
                    <input type="text" id="login-username" placeholder="ชื่อผู้ใช้งาน" required>
                    
                    <div class="password-container">
                        <input type="password" id="login-password" placeholder="รหัสผ่าน" required>
                        <button type="button" class="password-toggle" id="toggle-login-password">👁️</button>
                    </div>
                    
                    <button type="submit">เข้าสู่ระบบ</button>
                    <p id="login-message" class="error-message"></p>
                </form>
                <p style="text-align: center; margin-top: 15px;">
                    ใช้ชื่อผู้ใช้: <strong>admin</strong> และรหัสผ่าน: <strong>admin123</strong>
                </p>
            </div>
        </div>

        <!-- Activity Page Content -->
        <div id="activity-page" class="hidden">
            <section class="form-section">
                <h2>บันทึกกิจกรรมใหม่</h2>
                <form id="activity-form">
                    <label for="activity-name-select">เลือกกิจกรรม:</label>
                    <select id="activity-name-select" required>
                        <option value="">-- เลือกประเภทกิจกรรม --</option>
                        <!-- Options will be loaded here by JavaScript -->
                    </select>
                    <input type="date" id="activity-date" required>
                    <label for="start-time">เวลาเริ่มต้น:</label>
                    <input type="time" id="start-time" required>
                    <label for="end-time">เวลาสิ้นสุด:</label>
                    <input type="time" id="end-time" required>
                    <label for="activity-details">รายละเอียดกิจกรรม (ไม่บังคับ):</label>
                    <textarea id="activity-details" placeholder="เช่น การประชุมกับทีม, อ่านหนังสือบทที่ 5"></textarea>
                    <button type="submit" id="save-activity-button">บันทึกกิจกรรม</button>
                    <button type="button" id="update-activity-button" class="hidden">อัปเดตกิจกรรม</button>
                    <button type="button" id="cancel-edit-activity-button" class="hidden">ยกเลิก</button>
                    <p style="text-align: center; margin: 15px 0;">หรือใช้ตัวจับเวลา:</p>
                    <div class="button-group" style="justify-content: center;">
                        <button type="button" id="start-timer-button">เริ่มจับเวลา</button>
                        <button type="button" id="stop-timer-button" disabled>หยุดจับเวลา</button>
                    </div>
                    <span id="timer-display">00:00:00</span>
                    <p id="activity-message" class="error-message"></p>
                </form>
            </section>

            <section class="data-section">
                <h2>รายการกิจกรรมของคุณ</h2>
                <div class="filter-controls">
                    <input type="date" id="filter-date">
                    <select id="filter-activity-type">
                        <option value="">-- กรองตามประเภท --</option>
                    </select>
                    <button id="apply-filter-button">กรอง</button>
                    <button id="reset-filter-button">รีเซ็ต</button>
                </div>
                <table id="activity-list-table">
                    <thead>
                        <tr>
                            <th>ชื่อกิจกรรม</th>
                            <th>วันที่</th>
                            <th>เวลาเริ่มต้น</th>
                            <th>เวลาสิ้นสุด</th>
                            <th>ระยะเวลารวม</th>
                            <th>รายละเอียด</th> <!-- เพิ่มบรรทัดนี้ -->
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Activities will be loaded here by JavaScript -->
                    </tbody>
                </table>
            </section>
        </div>
        
        <!-- Activity Types Management Page Content -->
        <div id="activity-types-page" class="hidden">
            <section class="form-section">
                <h2>เพิ่ม/แก้ไขประเภทกิจกรรม</h2>
                <form id="activity-type-form">
                    <input type="text" id="activity-type-name" placeholder="ชื่อประเภทกิจกรรมใหม่" required>
                    <button type="submit" id="save-activity-type-button">เพิ่มประเภทกิจกรรม</button>
                    <button type="button" id="update-activity-type-button" class="hidden">อัปเดตประเภทกิจกรรม</button>
                    <button type="button" id="cancel-activity-type-edit-button" class="hidden">ยกเลิก</button>
                    <p id="activity-type-message" class="error-message"></p>
                </form>
            </section>

            <section class="data-section">
                <h2>ประเภทกิจกรรมทั้งหมด</h2>
                <table id="activity-types-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ชื่อประเภทกิจกรรม</th>
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Activity types will be loaded here by JavaScript -->
                    </tbody>
                </table>
            </section>
        </div>

        <!-- Summary Page Content -->
        <div id="summary-page" class="hidden">
            <section class="data-section">
                <h2>สรุปกิจกรรม</h2>
                <div class="filter-controls">
                    <label for="summary-type-select">ประเภทสรุป:</label>
                    <select id="summary-type-select">
                        <option value="single-day">ตามวันที่เลือก</option>
                        <option value="date-range">ตามช่วงวันที่</option>
                        <option value="all-time">ทั้งหมด</option>
                    </select>
                    <label for="summary-date-picker" id="label-summary-date-picker">เลือกวันที่:</label>
                    <input type="date" id="summary-date-picker">
                    <label for="summary-start-date" class="hidden" id="label-summary-start-date">จากวันที่:</label>
                    <input type="date" id="summary-start-date" class="hidden">
                    <label for="summary-end-date" class="hidden" id="label-summary-end-date">ถึงวันที่:</label>
                    <input type="date" id="summary-end-date" class="hidden">
                    <button id="view-summary-button">ดูสรุป</button>
                </div>

                <div id="daily-summary-results">
                    <p>กรุณาเลือกประเภทสรุปและวันที่เพื่อดูข้อมูล</p>
                </div>
            </section>
        </div>

        <!-- Admin Page Content -->
        <div id="admin-page" class="hidden">
            <!-- ADDED: Import/Export section -->
            <section class="data-section">
                <h2>นำเข้า/ส่งออกข้อมูล</h2>
                <div class="button-group">
                    <button id="export-data-button">บันทึกข้อมูล (JSON)</button>
                    <input type="file" id="import-data-input" accept=".json" class="hidden">
                    <button id="show-import-button">โหลดข้อมูล (JSON)</button>
                </div>
                <p id="import-export-message" class="info-message"></p>
            </section>

            <!-- User Management Section -->
            <section class="form-section">
                <h2>เพิ่มผู้ใช้งานใหม่</h2>
                <form id="admin-add-user-form">
                    <input type="text" id="admin-add-username" placeholder="ชื่อผู้ใช้งาน" required>
                    
                    <div class="password-container">
                        <input type="password" id="admin-add-password" placeholder="รหัสผ่าน" required>
                        <button type="button" class="password-toggle" id="toggle-admin-add-password">👁️</button>
                    </div>
                    
                    <div class="password-container">
                        <input type="password" id="admin-add-confirm-password" placeholder="ยืนยันรหัสผ่าน" required>
                        <button type="button" class="password-toggle" id="toggle-admin-add-confirm-password">👁️</button>
                    </div>
                    
                    <select id="admin-add-role" required>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                    <button type="submit">เพิ่มผู้ใช้งาน</button>
                    <p id="admin-add-user-message" class="error-message"></p>
                </form>
            </section>

            <section class="data-section">
                <h2>ผู้ใช้งานทั้งหมด</h2>
                <table id="user-list-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ชื่อผู้ใช้งาน</th>
                            <th>บทบาท</th>
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Users will be loaded here by JavaScript -->
                    </tbody>
                </table>
            </section>

            <section class="data-section">
                <h2>กิจกรรมทั้งหมด</h2>
                <div class="filter-controls">
                    <input type="text" id="admin-search-user" placeholder="ค้นหาผู้ใช้งาน">
                    <input type="date" id="admin-filter-date">
                    <select id="admin-filter-activity-type">
                        <option value="">-- กรองตามประเภท --</option>
                    </select>
                    <button id="admin-apply-filter-button">กรอง</button>
                    <button id="admin-reset-filter-button">รีเซ็ต</button>
                </div>
                <table id="all-activities-table">
                    <thead>
                        <tr>
                            <th>ผู้ใช้งาน</th>
                            <th>ชื่อกิจกรรม</th>
                            <th>วันที่</th>
                            <th>เวลาเริ่มต้น</th>
                            <th>เวลาสิ้นสุด</th>
                            <th>ระยะเวลารวม</th>
                            <th>รายละเอียด</th> <!-- เพิ่มบรรทัดนี้ -->
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- All activities will be loaded here by JavaScript -->
                    </tbody>
                </table>
            </section>
        </div>

    <!-- Modal for editing users -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">แก้ไขผู้ใช้งาน</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id">
                <input type="text" id="edit-user-username" placeholder="ชื่อผู้ใช้งาน" required>
                
                <div class="password-container">
                    <input type="password" id="edit-user-password" placeholder="รหัสผ่าน (เว้นว่างหากไม่ต้องการเปลี่ยน)">
                    <button type="button" class="password-toggle" id="toggle-edit-user-password">👁️</button>
                </div>
                
                <select id="edit-user-role" required>
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
                <button type="submit">อัปเดตผู้ใช้งาน</button>
                <p id="edit-user-message" class="error-message"></p>
            </form>
        </div>
    </div>
    
    <!-- Modal สำหรับเลือกรูปแบบการแสดงผลสรุป -->
    <div id="summaryOutputModal" class="modal-overlay">
        <div class="format-modal-content">
            <h3>เลือกรูปแบบการแสดงผลสรุป</h3>
            <div class="format-modal-buttons">
                <button class="btn-display" onclick="handleSummaryOutput('display')">แสดงบนจอ</button>
                <button class="btn-xlsx" onclick="handleSummaryOutput('xlsx')">บันทึกเป็น XLSX</button>
                <button class="btn-pdf" onclick="handleSummaryOutput('pdf')">บันทึกเป็น PDF</button>
                <button class="btn-cancel" onclick="closeSummaryOutputModal()">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Modal สำหรับแสดงสรุปบนจอ (ใหม่) -->
    <div id="summaryModal" class="summary-modal-overlay">
        <div class="summary-modal-content-container">
            <div id="modalBodyContent" class="summaryResult">
                <!-- เนื้อหาการสรุปจะถูกใส่ที่นี่โดย JavaScript -->
            </div>
            <div class="summary-modal-controls">
                <button id="saveSummaryAsImageBtn" class="summary-modal-close-btn" style="background-color: #007bff; margin-bottom: 15px;">บันทึกเป็นรูปภาพ</button>
                <div class="summary-control-group">
                    <label for="summaryFontSizeSlider">ปรับขนาดตัวอักษร:</label>
                    <input type="range" id="summaryFontSizeSlider" min="0.5" max="1.5" step="0.05" value="1.0">
                    <span id="summaryFontSizeValue">ขนาด: 100%</span>
                </div>
                <div class="summary-control-group">
                    <label for="summaryLineHeightSlider">ปรับขนาดของบรรทัด:</label>
                    <input type="range" id="summaryLineHeightSlider" min="0.01" max="1.5" step="0.01" value="0.5">
                    <span id="summaryLineHeightValue">ความสูงของบรรทัด: 0.5</span>
                </div>
                <button onclick="closeSummaryModal()" class="summary-modal-close-btn">ปิดหน้าต่างนี้</button>
            </div>
        </div>
    </div>

    <!-- Container สำหรับการพิมพ์ PDF -->
    <div id="print-container"></div>



<script>
    // ตัวแปรเก็บข้อมูลสรุปสำหรับการส่งออก
    let summaryContext = {};

    // ========== Common Functions ==========
    function getFromLocalStorage(key, defaultValue = []) {
        const data = localStorage.getItem(key);
        try {
            return data ? JSON.parse(data) : defaultValue;
        } catch (e) {
            console.error(`Error parsing data from localStorage for key "${key}":`, e);
            return defaultValue;
        }
    }

    function saveToLocalStorage(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
    }

    function getLoggedInUser() {
        const user = sessionStorage.getItem('loggedInUser');
        return user ? JSON.parse(user) : null;
    }

    function setLoggedInUser(user) {
        sessionStorage.setItem('loggedInUser', JSON.stringify(user));
    }

    function clearLoggedInUser() {
        sessionStorage.removeItem('loggedInUser');
    }

    function checkAdminAccess() {
        const user = getLoggedInUser();
        return user && user.role === 'admin';
    }

    function updateAdminLinkVisibility() {
        const loggedInUser = getLoggedInUser();
        const adminLink = document.getElementById('admin-link');
        if (adminLink) {
            if (loggedInUser && loggedInUser.role === 'admin') {
                adminLink.classList.remove('hidden');
            } else {
                adminLink.classList.add('hidden');
            }
        }
    }

    function formatDuration(minutes) {
        if (isNaN(minutes) || minutes < 0) return "เวลาไม่ถูกต้อง";
        const totalSeconds = Math.round(minutes * 60);
        const hours = Math.floor(totalSeconds / 3600);
        const remainingMinutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        let parts = [];
        if (hours > 0) parts.push(`${hours} ชั่วโมง`);
        if (remainingMinutes > 0) parts.push(`${remainingMinutes} นาที`);
        if (seconds > 0 && hours === 0 && remainingMinutes === 0) parts.push(`${seconds} วินาที`);
        
        if (parts.length === 0) return "0 นาที";
        return parts.join(' ');
    }
    
    function formatDurationHms(totalMinutes) {
        if (isNaN(totalMinutes) || totalMinutes < 0) return "00:00:00";
        const totalSeconds = Math.round(totalMinutes * 60);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function calculateDuration(start, end) {
        const startDate = new Date(`2000-01-01T${start}`);
        const endDate = new Date(`2000-01-01T${end}`);

        if (isNaN(startDate) || isNaN(endDate)) {
            return 0;
        }

        if (endDate < startDate) {
            endDate.setDate(endDate.getDate() + 1);
        }

        const diffMilliseconds = endDate - startDate;
        return diffMilliseconds / (1000 * 60);
    }

    function hashPassword(password) {
        let hash = 0;
        if (password.length === 0) return hash;
        for (let i = 0; i < password.length; i++) {
            const char = password.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return hash.toString();
    }

    function populateActivityTypeDropdowns(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;

        const activityTypes = getFromLocalStorage('activityTypes');
        const selectedValue = dropdown.value;

        dropdown.innerHTML = '<option value="">-- เลือกประเภทกิจกรรม --</option>';
        if (dropdownId === 'filter-activity-type' || dropdownId === 'admin-filter-activity-type') {
            dropdown.innerHTML = '<option value="">-- กรองตามประเภท --</option>';
        }

        activityTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type.name;
            option.textContent = type.name;
            dropdown.appendChild(option);
        });
        dropdown.value = selectedValue;
    }

    // ========== Password Toggle Functionality ==========
    function setupPasswordToggles() {
        const toggleLoginPassword = document.getElementById('toggle-login-password');
        const loginPasswordInput = document.getElementById('login-password');
        
        if (toggleLoginPassword && loginPasswordInput) {
            toggleLoginPassword.addEventListener('click', function() {
                if (loginPasswordInput.type === 'password') {
                    loginPasswordInput.type = 'text';
                    this.textContent = '🙈';
                } else {
                    loginPasswordInput.type = 'password';
                    this.textContent = '👁️';
                }
            });
        }
        
        const toggleAdminAddPassword = document.getElementById('toggle-admin-add-password');
        const adminAddPasswordInput = document.getElementById('admin-add-password');
        
        if (toggleAdminAddPassword && adminAddPasswordInput) {
            toggleAdminAddPassword.addEventListener('click', function() {
                if (adminAddPasswordInput.type === 'password') {
                    adminAddPasswordInput.type = 'text';
                    this.textContent = '🙈';
                } else {
                    adminAddPasswordInput.type = 'password';
                    this.textContent = '👁️';
                }
            });
        }
        
        const toggleAdminAddConfirmPassword = document.getElementById('toggle-admin-add-confirm-password');
        const adminAddConfirmPasswordInput = document.getElementById('admin-add-confirm-password');
        
        if (toggleAdminAddConfirmPassword && adminAddConfirmPasswordInput) {
            toggleAdminAddConfirmPassword.addEventListener('click', function() {
                if (adminAddConfirmPasswordInput.type === 'password') {
                    adminAddConfirmPasswordInput.type = 'text';
                    this.textContent = '🙈';
                } else {
                    adminAddConfirmPasswordInput.type = 'password';
                    this.textContent = '👁️';
                }
            });
        }
        
        const toggleEditUserPassword = document.getElementById('toggle-edit-user-password');
        const editUserPasswordInput = document.getElementById('edit-user-password');
        
        if (toggleEditUserPassword && editUserPasswordInput) {
            toggleEditUserPassword.addEventListener('click', function() {
                if (editUserPasswordInput.type === 'password') {
                    editUserPasswordInput.type = 'text';
                    this.textContent = '🙈';
                } else {
                    editUserPasswordInput.type = 'password';
                    this.textContent = '👁️';
                }
            });
        }
    }

    // ========== Modal Functions ==========
    function setupModalHandlers() {
        const editUserModal = document.getElementById('edit-user-modal');
        const closeModalButtons = document.querySelectorAll('.close-modal');
        
        closeModalButtons.forEach(button => {
            button.addEventListener('click', function() {
                editUserModal.style.display = 'none';
            });
        });
        
        window.addEventListener('click', function(event) {
            if (event.target === editUserModal) {
                editUserModal.style.display = 'none';
            }
        });
    }

    // ฟังก์ชันเปิด Modal เลือกรูปแบบการแสดงผล
    function openSummaryOutputModal() {
        document.getElementById('summaryOutputModal').style.display = 'flex';
    }

    // ฟังก์ชันปิด Modal
    function closeSummaryOutputModal() {
        document.getElementById('summaryOutputModal').style.display = 'none';
    }

    // ฟังก์ชันเปิด Modal แสดงสรุป
    function openSummaryModal(htmlContent) {
        const modal = document.getElementById('summaryModal');
        const modalBody = document.getElementById('modalBodyContent');
        modalBody.innerHTML = htmlContent;
        modal.style.display = 'flex';
        setupSummaryModalControls(); // เรียกใช้ฟังก์ชันตั้งค่าปุ่มและแถบเลื่อน
    }

    // ฟังก์ชันปิด Modal แสดงสรุป
    function closeSummaryModal() {
        const modal = document.getElementById('summaryModal');
        modal.style.display = 'none';
    }

    // ฟังก์ชันตั้งค่าควบคุมใน Modal แสดงสรุป
    function setupSummaryModalControls() {
        const modalContentContainer = document.querySelector("#summaryModal .summary-modal-content-container");
        const modalBody = document.getElementById("modalBodyContent");
        if (!modalBody || !modalContentContainer) return;

        // --- Font Size Controls ---
        const textElements = modalBody.querySelectorAll('p, h3, h4, strong, th, td, span, div, li');
        const fsSlider = document.getElementById("summaryFontSizeSlider");
        const fsValueSpan = document.getElementById("summaryFontSizeValue");

        textElements.forEach(el => {
            if (!el.dataset.originalSize) {
                el.dataset.originalSize = parseFloat(window.getComputedStyle(el).fontSize);
            }
        });

        function updateFontSize() {
            const scale = fsSlider.value;
            textElements.forEach(el => {
                const originalSize = parseFloat(el.dataset.originalSize);
                if (originalSize) {
                    el.style.fontSize = (originalSize * scale) + 'px';
                }
            });
            fsValueSpan.textContent = "ขนาด: " + Math.round(scale * 100) + "%";
        }

        fsSlider.addEventListener("input", updateFontSize);

        // --- Line Height Controls ---
        const lhSlider = document.getElementById("summaryLineHeightSlider");
        const lhValueSpan = document.getElementById("summaryLineHeightValue");

        function updateLineHeight() {
            const lineHeight = lhSlider.value;
            modalBody.style.lineHeight = lineHeight;
            lhValueSpan.textContent = "ความสูงของบรรทัด: " + lineHeight;
        }

        lhSlider.addEventListener("input", updateLineHeight);

        // --- Save as Image Button Logic ---
        const saveBtn = document.getElementById("saveSummaryAsImageBtn");
        saveBtn.addEventListener("click", function() {
            const controlsElement = modalContentContainer.querySelector('.summary-modal-controls');

            // Temporarily hide controls for capture
            if (controlsElement) controlsElement.style.display = 'none';

            html2canvas(modalContentContainer, {
                useCORS: true,
                scale: 4, // Higher resolution
                backgroundColor: '#FAFAD2' // Match content background
            }).then(canvas => {
                const link = document.createElement('a');
                const fileName = `สรุปกิจกรรม_${new Date().getTime()}.png`;
                link.download = fileName;
                link.href = canvas.toDataURL("image/png");
                link.click();
            }).catch(err => {
                console.error("Error creating image:", err);
                alert("ขออภัย, ไม่สามารถบันทึกเป็นรูปภาพได้");
            }).finally(() => {
                // Show controls again
                if (controlsElement) controlsElement.style.display = '';
            });
        });

        // Initial setup
        updateFontSize();
        updateLineHeight();
    }

    // ฟังก์ชันจัดการการเลือกรูปแบบการแสดงผล
    function handleSummaryOutput(choice) {
        if (!summaryContext || !summaryContext.summaryResult) {
            console.error("Summary context is missing. Cannot proceed.");
            alert('เกิดข้อผิดพลาด: ไม่พบข้อมูลสรุป');
            closeSummaryOutputModal();
            return;
        }
        
        try {
            if (choice === 'display') {
                const htmlContent = buildSummaryHtml(summaryContext);
                openSummaryModal(htmlContent);
            } else if (choice === 'xlsx') {
                exportSummaryToXlsx(summaryContext);
            } else if (choice === 'pdf') {
                exportSummaryToPdf(summaryContext);
            }
        } catch (error) {
            console.error('Error in handleSummaryOutput:', error);
            alert('เกิดข้อผิดพลาดในการประมวลผล: ' + error.message);
        }
        
        closeSummaryOutputModal();
    }

    // ฟังก์ชันสร้าง HTML สำหรับสรุปกิจกรรม
    function buildSummaryHtml(context) {
        const { summaryResult, title, periodName } = context;
        const { summary, totalMinutes, activities } = summaryResult;
        
        const loggedInUser = getLoggedInUser();
        const summaryDateTime = new Date().toLocaleString("th-TH", { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit'
        }) + ' น.';
        
        let summaryHtml = `
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>สรุปกิจกรรม</h2>
                <p><strong>ผู้ใช้:</strong> ${loggedInUser.username}</p>
                <p><strong>สรุปเมื่อวันที่:</strong> ${summaryDateTime}</p>
                <p><strong>ช่วงเวลา:</strong> ${title}</p>
            </div>
            <hr style="border: 0.5px solid green;">
            <h3>สรุปตามประเภทกิจกรรม</h3>
            <ul style="list-style-type: none; padding: 0;">
        `;
        
        for (const [activityName, totalMinutes] of Object.entries(summary)) {
            summaryHtml += `<li style="margin-bottom: 10px;"><strong>${activityName}:</strong> ${formatDuration(totalMinutes)} (${formatDurationHms(totalMinutes)})</li>`;
        }
        
        summaryHtml += `</ul>`;
        summaryHtml += `<p style="font-weight: bold; color: #28a745; margin-top: 15px;">รวมระยะเวลาทั้งหมด: ${formatDuration(totalMinutes)} (${formatDurationHms(totalMinutes)})</p>`;
        
        if (activities.length > 0) {
            summaryHtml += `<div style="margin-top: 20px;">
                <h3>รายละเอียดกิจกรรม</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">กิจกรรม</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">วันที่</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">เวลาเริ่มต้น</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">เวลาสิ้นสุด</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">ระยะเวลา</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">รายละเอียด</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            activities.forEach(activity => {
                const durationMinutes = calculateDuration(activity.startTime, activity.endTime);
                summaryHtml += `<tr>`;
                summaryHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${activity.activityName}</td>`;
                summaryHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${formatDate(activity.date)}</td>`;
                summaryHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${activity.startTime}</td>`;
                summaryHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${activity.endTime}</td>`;
                summaryHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${formatDuration(durationMinutes)}</td>`;
                summaryHtml += `<td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${activity.details || '-'}</td>`;
                summaryHtml += `</tr>`;
            });
            
            summaryHtml += `</tbody></table></div>`;
        } else {
            summaryHtml += `<p>ไม่พบกิจกรรมในช่วงเวลาที่เลือก</p>`;
        }
        
        return summaryHtml;
    }

    // ฟังก์ชันส่งออกสรุปเป็นไฟล์ XLSX
    function exportSummaryToXlsx(context) {
        const { summaryResult, title, periodName } = context;
        const { summary, totalMinutes, activities } = summaryResult;
        
        const loggedInUser = getLoggedInUser();
        
        const wb = XLSX.utils.book_new();
        
        let excelData = [];
        
        const summaryDateTime = new Date().toLocaleString("th-TH", { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit'
        }) + ' น.';
        
        // ส่วนหัวเอกสาร
        excelData.push(['สรุปกิจกรรม']);
        excelData.push(['ผู้ใช้:', loggedInUser.username]);
        excelData.push(['สรุปเมื่อวันที่:', summaryDateTime]);
        excelData.push(['ช่วงเวลา:', title]);
        excelData.push([]);
        
        // สรุปตามประเภทกิจกรรม
        excelData.push(['--- สรุปตามประเภทกิจกรรม ---']);
        excelData.push(['ประเภทกิจกรรม', 'ระยะเวลา (นาที)', 'ระยะเวลา (ชม.:นาที:วินาที)']);
        
        for (const [activityName, totalMinutes] of Object.entries(summary)) {
            excelData.push([activityName, totalMinutes, formatDurationHms(totalMinutes)]);
        }
        
        excelData.push([]);
        excelData.push(['รวมระยะเวลาทั้งหมด:', totalMinutes, formatDurationHms(totalMinutes)]);
        excelData.push([]);
        
        // รายละเอียดกิจกรรม
        if (activities.length > 0) {
            excelData.push(['--- รายละเอียดกิจกรรม ---']);
            excelData.push(['กิจกรรม', 'วันที่', 'เวลาเริ่มต้น', 'เวลาสิ้นสุด', 'ระยะเวลา (นาที)', 'ระยะเวลา (ชม.:นาที:วินาที)', 'รายละเอียด']);
            
            activities.forEach(activity => {
                const durationMinutes = calculateDuration(activity.startTime, activity.endTime);
                excelData.push([
                    activity.activityName,
                    activity.date,
                    activity.startTime,
                    activity.endTime,
                    durationMinutes,
                    formatDurationHms(durationMinutes),
                    activity.details || '-'
                ]);
            });
        }
        
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // ตั้งค่าความกว้างของคอลัมน์
        const colWidths = [
            {wch: 25},
            {wch: 15},
            {wch: 12},
            {wch: 12},
            {wch: 15},
            {wch: 20},
            {wch: 40} // เพิ่มความกว้างสำหรับคอลัมน์รายละเอียด
        ];
        ws['!cols'] = colWidths;
        
        // ตั้งค่าหน้ากระดาษสำหรับพิมพ์
        ws['!pageSetup'] = {
            orientation: 'landscape',
            paperSize: 9, // A4
            fitToPage: true,
            fitToWidth: 1,
            fitToHeight: 0,
            margins: {
                left: 0.7, right: 0.7,
                top: 0.75, bottom: 0.75,
                header: 0.3, footer: 0.3
            }
        };
        
        XLSX.utils.book_append_sheet(wb, ws, "สรุปกิจกรรม");
        
        const fileName = `สรุปกิจกรรม_${periodName}_${new Date().getTime()}.xlsx`;
        
        XLSX.writeFile(wb, fileName);
    }

    // ฟังก์ชันสร้าง HTML สำหรับสรุปกิจกรรมในการพิมพ์ PDF
    function buildPdfSummaryHtml(context) {
        const { summaryResult, title, periodName } = context;
        const { summary, totalMinutes, activities } = summaryResult;
        
        const loggedInUser = getLoggedInUser();
        const summaryDateTime = new Date().toLocaleString("th-TH", { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit'
        }) + ' น.';
        
        let summaryHtml = `
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>สรุปกิจกรรม</h2>
                <p><strong>ผู้ใช้:</strong> ${loggedInUser.username}</p>
                <p><strong>สรุปเมื่อวันที่:</strong> ${summaryDateTime}</p>
                <p><strong>ช่วงเวลา:</strong> ${title}</p>
            </div>
            <hr style="border: 0.5px solid green;">
            <h3>สรุปตามประเภทกิจกรรม</h3>
            <ul style="list-style-type: none; padding: 0;">
        `;
        
        for (const [activityName, totalMinutes] of Object.entries(summary)) {
            summaryHtml += `<li style="margin-bottom: 10px; line-height: 0.5;"><strong>${activityName}:</strong> ${formatDuration(totalMinutes)} (${formatDurationHms(totalMinutes)})</li>`;
        }
        
        summaryHtml += `</ul>`;
        summaryHtml += `<p style="font-weight: bold; color: #28a745; margin-top: 15px; line-height: 0.5;">รวมระยะเวลาทั้งหมด: ${formatDuration(totalMinutes)} (${formatDurationHms(totalMinutes)})</p>`;
        
        if (activities.length > 0) {
            summaryHtml += `<div style="margin-top: 20px;">
                <h3>รายละเอียดกิจกรรม</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">กิจกรรม</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">วันที่</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">เวลาเริ่มต้น</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">เวลาสิ้นสุด</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">ระยะเวลา</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">รายละเอียด</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            activities.forEach(activity => {
                const durationMinutes = calculateDuration(activity.startTime, activity.endTime);
                summaryHtml += `<tr>`;
                summaryHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${activity.activityName}</td>`;
                summaryHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${formatDate(activity.date)}</td>`;
                summaryHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${activity.startTime}</td>`;
                summaryHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${activity.endTime}</td>`;
                summaryHtml += `<td style="border: 1px solid #ddd; padding: 8px;">${formatDuration(durationMinutes)}</td>`;
                summaryHtml += `<td style="border: 1px solid #ddd; padding: 8px; text-align: left;">${activity.details || '-'}</td>`;
                summaryHtml += `</tr>`;
            });
            
            summaryHtml += `</tbody></table></div>`;
        } else {
            summaryHtml += `<p>ไม่พบกิจกรรมในช่วงเวลาที่เลือก</p>`;
        }
        
        return summaryHtml;
    }

    // ฟังก์ชันส่งออกสรุปเป็นไฟล์ PDF (ปรับปรุงใหม่ให้ใช้การพิมพ์เหมือนไฟล์ 01)
    function exportSummaryToPdf(context) {
        const printContainer = document.getElementById('print-container');
        if (printContainer) {
            const htmlForPdf = buildPdfSummaryHtml(context);
            printContainer.innerHTML = `<div class="summaryResult">${htmlForPdf}</div>`;
            setTimeout(() => { 
                window.print(); 
            }, 250);
        }
    }
    // ========== Page Navigation ==========
    function showPage(pageName) {
        console.log('กำลังแสดงหน้า:', pageName);
        
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('activity-page').classList.add('hidden');
        document.getElementById('activity-types-page').classList.add('hidden');
        document.getElementById('summary-page').classList.add('hidden');
        document.getElementById('admin-page').classList.add('hidden');
        
        const loggedInUser = getLoggedInUser();
        const mainHeader = document.getElementById('main-header');
        const mainNav = document.getElementById('main-nav');
        const welcomeMessageElement = document.getElementById('welcome-message');

        if (loggedInUser) {
            mainHeader.classList.remove('hidden');
            mainNav.style.display = 'flex';
            welcomeMessageElement.textContent = `ยินดีต้อนรับ, ${loggedInUser.username} (${loggedInUser.role})!`;
            updateAdminLinkVisibility();
        } else {
            mainHeader.classList.add('hidden');
            mainNav.style.display = 'none';
        }
        
        if (pageName === 'auth') {
            document.getElementById('auth-section').classList.remove('hidden');
            setupAuthHandlers();
        } else if (pageName === 'activity') {
            if (!loggedInUser) { 
                alert('กรุณาเข้าสู่ระบบ'); 
                showPage('auth'); 
                return; 
            }
            document.getElementById('activity-page').classList.remove('hidden');
            setupActivityHandlers();
        } else if (pageName === 'activity-types') {
            if (!loggedInUser) { 
                alert('กรุณาเข้าสู่ระบบ'); 
                showPage('auth'); 
                return; 
            }
            document.getElementById('activity-types-page').classList.remove('hidden');
            setupActivityTypesHandlers();
        } else if (pageName === 'summary') {
            if (!loggedInUser) { 
                alert('กรุณาเข้าสู่ระบบ'); 
                showPage('auth'); 
                return; 
            }
            document.getElementById('summary-page').classList.remove('hidden');
            setupSummaryHandlers();
        } else if (pageName === 'admin') {
            if (!checkAdminAccess()) {
                alert('คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                showPage(loggedInUser ? 'activity' : 'auth');
                return;
            }
            document.getElementById('admin-page').classList.remove('hidden');
            setupAdminHandlers();
        }
        
        document.querySelectorAll('#main-nav a').forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('data-page') === pageName) {
                link.classList.add('active');
            }
        });
    }

    // ========== Authentication Functions ==========
    function setupAuthHandlers() {
        const loginForm = document.getElementById('login-form');
        const loginMessage = document.getElementById('login-message');

        loginMessage.textContent = '';

        loginForm.onsubmit = (e) => { 
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            let users = getFromLocalStorage('users');

            const hashedPassword = hashPassword(password);

            const user = users.find(u => u.username === username && u.password === hashedPassword);

            if (user) {
                setLoggedInUser(user);
                loginMessage.textContent = '';
                alert('เข้าสู่ระบบสำเร็จ!');
                showPage('activity');
            } else {
                loginMessage.textContent = 'ชื่อผู้ใช้งานหรือรหัสผ่านไม่ถูกต้อง';
            }
        };
    }

    // ========== Activity Functions ==========
    function setupActivityHandlers() {
        const activityForm = document.getElementById('activity-form');
        const activityNameSelect = document.getElementById('activity-name-select');
        const activityDateInput = document.getElementById('activity-date');
        const startTimeInput = document.getElementById('start-time');
        const endTimeInput = document.getElementById('end-time');
        const activityDetailsInput = document.getElementById('activity-details'); // อ้างอิงถึง input รายละเอียด
        const activityMessage = document.getElementById('activity-message');
        const activityListTableBody = document.querySelector('#activity-list-table tbody');
        const saveActivityButton = document.getElementById('save-activity-button');
        const updateActivityButton = document.getElementById('update-activity-button');
        const cancelEditActivityButton = document.getElementById('cancel-edit-activity-button');

        const startTimerButton = document.getElementById('start-timer-button');
        const stopTimerButton = document.getElementById('stop-timer-button');
        const timerDisplay = document.getElementById('timer-display');

        const filterDateInput = document.getElementById('filter-date');
        const filterActivityTypeSelect = document.getElementById('filter-activity-type');
        const applyFilterButton = document.getElementById('apply-filter-button');
        const resetFilterButton = document.getElementById('reset-filter-button');
        
        let loggedInUser = getLoggedInUser();
        let editingActivityId = null;
        let timerInterval;
        let timerStartTime = null;

        const today = new Date();
        activityDateInput.valueAsDate = today;
        filterDateInput.valueAsDate = today;

        populateActivityTypeDropdowns('activity-name-select');
        populateActivityTypeDropdowns('filter-activity-type');

        function displayActivities(activitiesToDisplay) {
            activityListTableBody.innerHTML = '';

            activitiesToDisplay.forEach(activity => {
                const row = activityListTableBody.insertRow();
                const durationMinutes = calculateDuration(activity.startTime, activity.endTime);
                
                row.insertCell().textContent = activity.activityName;
                row.insertCell().textContent = formatDate(activity.date);
                row.insertCell().textContent = activity.startTime;
                row.insertCell().textContent = activity.endTime;
                row.insertCell().textContent = formatDuration(durationMinutes);
                row.insertCell().textContent = activity.details || '-'; // แสดงรายละเอียด หรือ '-' ถ้าไม่มี
                
                const actionsCell = row.insertCell();
                const editButton = document.createElement('button');
                editButton.textContent = 'แก้ไข';
                editButton.className = 'action-buttons';
                editButton.onclick = () => editActivity(activity.id); 
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'ลบ';
                deleteButton.className = 'action-buttons delete-button';
                deleteButton.onclick = () => deleteActivity(activity.id);
                actionsCell.appendChild(deleteButton);
            });
        }

        function loadAndDisplayUserActivities() {
            const allActivities = getFromLocalStorage('activities');
            const userActivities = allActivities.filter(act => act.userId === loggedInUser.id);
            displayActivities(userActivities);
        }

        function editActivity(id) {
            editingActivityId = id;
            const allActivities = getFromLocalStorage('activities');
            const activityToEdit = allActivities.find(act => act.id === id);

            if (activityToEdit) {
                activityNameSelect.value = activityToEdit.activityName;
                activityDateInput.value = activityToEdit.date;
                startTimeInput.value = activityToEdit.startTime;
                endTimeInput.value = activityToEdit.endTime;
                activityDetailsInput.value = activityToEdit.details || ''; // ดึงรายละเอียดมาแสดงในฟอร์ม

                saveActivityButton.classList.add('hidden');
                updateActivityButton.classList.remove('hidden');
                cancelEditActivityButton.classList.remove('hidden');
                activityMessage.textContent = 'กำลังแก้ไขกิจกรรม...';
                activityMessage.style.color = 'blue';

                startTimerButton.disabled = true;
                stopTimerButton.disabled = true;
                clearInterval(timerInterval);
                timerDisplay.textContent = '00:00:00';
            }
        }

        updateActivityButton.onclick = () => {
            if (editingActivityId === null) return;

            const activityName = activityNameSelect.value;
            const date = activityDateInput.value;
            const startTime = startTimeInput.value;
            const endTime = endTimeInput.value;
            const details = activityDetailsInput.value; // ดึงค่ารายละเอียดจาก input

            if (!activityName) {
                activityMessage.textContent = 'กรุณาเลือกประเภทกิจกรรม';
                activityMessage.style.color = 'red';
                return;
            }

            if (startTime >= endTime && date === activityDateInput.value) { 
                activityMessage.textContent = 'เวลาสิ้นสุดต้องมากกว่าเวลาเริ่มต้นในวันเดียวกัน';
                activityMessage.style.color = 'red';
                return;
            }

            let allActivities = getFromLocalStorage('activities');
            const activityIndex = allActivities.findIndex(act => act.id === editingActivityId);

            if (activityIndex !== -1) {
                allActivities[activityIndex] = {
                    ...allActivities[activityIndex],
                    activityName: activityName,
                    date: date,
                    startTime: startTime,
                    endTime: endTime,
                    details: details // อัปเดตรายละเอียดกิจกรรม
                };
                saveToLocalStorage('activities', allActivities);
                activityMessage.textContent = 'อัปเดตกิจกรรมสำเร็จ';
                activityMessage.style.color = 'green';
                resetActivityForm();
                loadAndDisplayUserActivities();
                setTimeout(() => activityMessage.textContent = '', 3000);
            }
        };

        cancelEditActivityButton.onclick = () => {
            resetActivityForm();
            activityMessage.textContent = '';
        };

        function resetActivityForm() {
            activityForm.reset();
            activityDateInput.valueAsDate = new Date();
            editingActivityId = null;
            saveActivityButton.classList.remove('hidden');
            updateActivityButton.classList.add('hidden');
            cancelEditActivityButton.classList.add('hidden');
            startTimerButton.disabled = false;
            stopTimerButton.disabled = true;
            clearInterval(timerInterval);
            timerDisplay.textContent = '00:00:00';
            activityMessage.textContent = '';
            activityDetailsInput.value = ''; // เพิ่มการรีเซ็ตค่ารายละเอียด
        }

        function deleteActivity(id) {
            if (confirm('คุณแน่ใจหรือไม่ที่จะลบกิจกรรมนี้?')) {
                let allActivities = getFromLocalStorage('activities');
                allActivities = allActivities.filter(act => act.id !== id);
                saveToLocalStorage('activities', allActivities);
                loadAndDisplayUserActivities();
                activityMessage.textContent = 'ลบกิจกรรมสำเร็จ';
                activityMessage.style.color = 'green';
                setTimeout(() => activityMessage.textContent = '', 3000);
            }
        }

        activityForm.onsubmit = (e) => { 
            e.preventDefault();
            if (editingActivityId !== null) return;

            const activityName = activityNameSelect.value;
            const date = activityDateInput.value;
            const startTime = startTimeInput.value;
            const endTime = endTimeInput.value;
            const details = activityDetailsInput.value; // ดึงค่ารายละเอียดจาก input

            if (!activityName) {
                activityMessage.textContent = 'กรุณาเลือกประเภทกิจกรรม';
                activityMessage.style.color = 'red';
                return;
            }

            if (startTime >= endTime && date === activityDateInput.value) { 
                activityMessage.textContent = 'เวลาสิ้นสุดต้องมากกว่าเวลาเริ่มต้นในวันเดียวกัน';
                activityMessage.style.color = 'red';
                return;
            }

            let allActivities = getFromLocalStorage('activities');
            const newActivity = {
                id: allActivities.length > 0 ? Math.max(...allActivities.map(a => a.id)) + 1 : 1,
                userId: loggedInUser.id,
                activityName: activityName,
                date: date,
                startTime: startTime,
                endTime: endTime,
                details: details // เพิ่มรายละเอียดกิจกรรมเมื่อบันทึกใหม่
            };
            allActivities.push(newActivity);
            saveToLocalStorage('activities', allActivities);
            activityMessage.textContent = 'บันทึกกิจกรรมสำเร็จ';
            activityMessage.style.color = 'green';
            resetActivityForm();
            loadAndDisplayUserActivities();
            setTimeout(() => activityMessage.textContent = '', 3000);
        };

        function updateTimerDisplay(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            timerDisplay.textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        startTimerButton.onclick = () => { 
            if (editingActivityId !== null) return;

            timerStartTime = new Date();
            startTimerButton.disabled = true;
            stopTimerButton.disabled = false;
            activityDateInput.valueAsDate = new Date();
            startTimeInput.value = timerStartTime.toTimeString().slice(0, 5);
            endTimeInput.value = '';
            activityMessage.textContent = 'เริ่มจับเวลา...';
            activityMessage.style.color = 'blue';

            timerInterval = setInterval(() => {
                const elapsed = new Date() - timerStartTime;
                updateTimerDisplay(elapsed);
            }, 1000);
        };

        stopTimerButton.onclick = () => { 
            clearInterval(timerInterval);
            stopTimerButton.disabled = true;
            startTimerButton.disabled = false;
            endTimeInput.value = new Date().toTimeString().slice(0, 5);
            timerDisplay.textContent = '00:00:00';
            activityMessage.textContent = 'หยุดจับเวลาแล้ว กรุณาบันทึกกิจกรรม';
            activityMessage.style.color = 'green';
        };

        applyFilterButton.onclick = () => { 
            const filterDate = filterDateInput.value;
            const filterActivityType = filterActivityTypeSelect.value;
            
            const allActivities = getFromLocalStorage('activities');
            let filteredActivities = allActivities.filter(act => act.userId === loggedInUser.id);

            if (filterDate) {
                filteredActivities = filteredActivities.filter(act => act.date === filterDate);
            }
            if (filterActivityType) {
                filteredActivities = filteredActivities.filter(act => act.activityName === filterActivityType);
            }
            displayActivities(filteredActivities);
        };

        resetFilterButton.onclick = () => {
            filterDateInput.value = '';
            filterActivityTypeSelect.value = '';
            loadAndDisplayUserActivities();
        };

        loadAndDisplayUserActivities();
    }

    // ========== Activity Types Management Functions ==========
    let editingActivityTypeId = null;

    function setupActivityTypesHandlers() {
        const activityTypeForm = document.getElementById('activity-type-form');
        const activityTypeNameInput = document.getElementById('activity-type-name');
        const saveActivityTypeButton = document.getElementById('save-activity-type-button');
        const updateActivityTypeButton = document.getElementById('update-activity-type-button');
        const cancelActivityTypeEditButton = document.getElementById('cancel-activity-type-edit-button');
        const activityTypeMessage = document.getElementById('activity-type-message');
        const activityTypesTableBody = document.querySelector('#activity-types-table tbody');
        
        const loggedInUser = getLoggedInUser();
        if (!loggedInUser) { alert('กรุณาเข้าสู่ระบบ'); showPage('auth'); return; }

        function displayActivityTypes() {
            activityTypesTableBody.innerHTML = '';
            const activityTypes = getFromLocalStorage('activityTypes');

            activityTypes.forEach(type => {
                const row = activityTypesTableBody.insertRow();
                row.insertCell().textContent = type.id;
                row.insertCell().textContent = type.name;
                
                const actionsCell = row.insertCell();
                const editButton = document.createElement('button');
                editButton.textContent = 'แก้ไข';
                editButton.className = 'action-buttons';
                editButton.onclick = () => editActivityType(type.id);
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'ลบ';
                deleteButton.className = 'action-buttons delete-button';
                deleteButton.onclick = () => deleteActivityType(type.id);
                actionsCell.appendChild(deleteButton);
            });
        }

        function editActivityType(id) {
            editingActivityTypeId = id;
            const activityTypes = getFromLocalStorage('activityTypes');
            const typeToEdit = activityTypes.find(type => type.id === id);

            if (typeToEdit) {
                activityTypeNameInput.value = typeToEdit.name;
                saveActivityTypeButton.classList.add('hidden');
                updateActivityTypeButton.classList.remove('hidden');
                cancelActivityTypeEditButton.classList.remove('hidden');
                activityTypeMessage.textContent = 'กำลังแก้ไขประเภทกิจกรรม...';
                activityTypeMessage.style.color = 'blue';
            }
        }

        function deleteActivityType(id) {
            if (confirm('การลบประเภทกิจกรรมนี้จะไม่ลบกิจกรรมที่บันทึกไว้แล้ว คุณแน่ใจหรือไม่ที่จะลบ?')) {
                let activityTypes = getFromLocalStorage('activityTypes');
                activityTypes = activityTypes.filter(type => type.id !== id);
                saveToLocalStorage('activityTypes', activityTypes);
                displayActivityTypes();
                activityTypeMessage.textContent = 'ลบประเภทกิจกรรมสำเร็จ';
                activityTypeMessage.style.color = 'green';
                populateActivityTypeDropdowns('activity-name-select');
                populateActivityTypeDropdowns('filter-activity-type');
                populateActivityTypeDropdowns('admin-filter-activity-type');
                setTimeout(() => activityTypeMessage.textContent = '', 3000);
            }
        }

        function resetActivityTypeForm() {
            activityTypeForm.reset();
            editingActivityTypeId = null;
            saveActivityTypeButton.classList.remove('hidden');
            updateActivityTypeButton.classList.add('hidden');
            cancelActivityTypeEditButton.classList.add('hidden');
            activityTypeMessage.textContent = '';
        }

        activityTypeForm.onsubmit = (e) => {
            e.preventDefault();
            if (editingActivityTypeId !== null) return;

            const newTypeName = activityTypeNameInput.value.trim();
            if (!newTypeName) {
                activityTypeMessage.textContent = 'กรุณากรอกชื่อประเภทกิจกรรม';
                activityTypeMessage.style.color = 'red';
                return;
            }

            let activityTypes = getFromLocalStorage('activityTypes');
            if (activityTypes.some(type => type.name.toLowerCase() === newTypeName.toLowerCase())) {
                activityTypeMessage.textContent = 'ชื่อประเภทกิจกรรมนี้มีอยู่แล้ว';
                activityTypeMessage.style.color = 'red';
                return;
            }

            const newType = {
                id: activityTypes.length > 0 ? Math.max(...activityTypes.map(t => t.id)) + 1 : 1,
                name: newTypeName
            };
            activityTypes.push(newType);
            saveToLocalStorage('activityTypes', activityTypes);
            activityTypeMessage.textContent = 'เพิ่มประเภทกิจกรรมสำเร็จ';
            activityTypeMessage.style.color = 'green';
            resetActivityTypeForm();
            displayActivityTypes();
            populateActivityTypeDropdowns('activity-name-select');
            populateActivityTypeDropdowns('filter-activity-type');
            populateActivityTypeDropdowns('admin-filter-activity-type');
            setTimeout(() => activityTypeMessage.textContent = '', 3000);
        };

        updateActivityTypeButton.onclick = () => {
            if (editingActivityTypeId === null) return;

            const updatedTypeName = activityTypeNameInput.value.trim();
            if (!updatedTypeName) {
                activityTypeMessage.textContent = 'กรุณากรอกชื่อประเภทกิจกรรม';
                activityTypeMessage.style.color = 'red';
                return;
            }

            let activityTypes = getFromLocalStorage('activityTypes');
            const activityTypeIndex = activityTypes.findIndex(type => type.id === editingActivityTypeId);

            if (activityTypeIndex !== -1) {
                if (activityTypes.some(type => type.name.toLowerCase() === updatedTypeName.toLowerCase() && type.id !== editingActivityTypeId)) {
                    activityTypeMessage.textContent = 'ชื่อประเภทกิจกรรมนี้มีอยู่แล้ว';
                    activityTypeMessage.style.color = 'red';
                    return;
                }

                const oldTypeName = activityTypes[activityTypeIndex].name;
                let allActivities = getFromLocalStorage('activities');
                allActivities.forEach(activity => {
                    if (activity.activityName === oldTypeName) {
                        activity.activityName = updatedTypeName;
                    }
                });
                saveToLocalStorage('activities', allActivities);

                activityTypes[activityTypeIndex].name = updatedTypeName;
                saveToLocalStorage('activityTypes', activityTypes);
                
                activityTypeMessage.textContent = 'อัปเดตประเภทกิจกรรมสำเร็จ';
                activityTypeMessage.style.color = 'green';
                resetActivityTypeForm();
                displayActivityTypes();
                populateActivityTypeDropdowns('activity-name-select');
                populateActivityTypeDropdowns('filter-activity-type');
                populateActivityTypeDropdowns('admin-filter-activity-type');
                setTimeout(() => activityTypeMessage.textContent = '', 3000);
            }
        };

        cancelActivityTypeEditButton.onclick = () => {
            resetActivityTypeForm();
        };

        displayActivityTypes();
    }

    // ========== Summary Functions ==========
    function setupSummaryHandlers() {
        const summaryTypeSelect = document.getElementById('summary-type-select');
        const summaryDatePicker = document.getElementById('summary-date-picker');
        const summaryStartDateInput = document.getElementById('summary-start-date');
        const summaryEndDateInput = document.getElementById('summary-end-date');
        const labelSummaryDatePicker = document.getElementById('label-summary-date-picker');
        const labelSummaryStartDate = document.getElementById('label-summary-start-date');
        const labelSummaryEndDate = document.getElementById('label-summary-end-date');

        const viewSummaryButton = document.getElementById('view-summary-button');
        const dailySummaryResults = document.getElementById('daily-summary-results');
        
        let loggedInUser = getLoggedInUser();

        const today = new Date();
        summaryDatePicker.valueAsDate = today;
        summaryStartDateInput.valueAsDate = today;
        summaryEndDateInput.valueAsDate = today;

        function updateSummaryInputsVisibility() {
            const selectedType = summaryTypeSelect.value;
            if (selectedType === 'single-day') {
                summaryDatePicker.classList.remove('hidden');
                labelSummaryDatePicker.classList.remove('hidden');
                summaryStartDateInput.classList.add('hidden');
                summaryEndDateInput.classList.add('hidden');
                labelSummaryStartDate.classList.add('hidden');
                labelSummaryEndDate.classList.add('hidden');
            } else if (selectedType === 'date-range') {
                summaryDatePicker.classList.add('hidden');
                labelSummaryDatePicker.classList.add('hidden');
                summaryStartDateInput.classList.remove('hidden');
                summaryEndDateInput.classList.remove('hidden');
                labelSummaryStartDate.classList.remove('hidden');
                labelSummaryEndDate.classList.remove('hidden');
            } else {
                summaryDatePicker.classList.add('hidden');
                labelSummaryDatePicker.classList.add('hidden');
                summaryStartDateInput.classList.add('hidden');
                summaryEndDateInput.classList.add('hidden');
                labelSummaryStartDate.classList.add('hidden');
                labelSummaryEndDate.classList.add('hidden');
            }
        }

        summaryTypeSelect.onchange = updateSummaryInputsVisibility;

        viewSummaryButton.onclick = () => { 
            const summaryType = summaryTypeSelect.value;
            let activitiesToSummarize = [];
            const allActivities = getFromLocalStorage('activities');
            const userActivities = allActivities.filter(act => act.userId === loggedInUser.id);

            let summaryTitle = '';
            let totalOverallMinutes = 0;
            let periodName = '';

            if (summaryType === 'single-day') {
                const selectedDate = summaryDatePicker.value;
                if (!selectedDate) {
                    dailySummaryResults.innerHTML = '<p class="error-message">กรุณาเลือกวันที่</p>';
                    return;
                }
                activitiesToSummarize = userActivities.filter(act => act.date === selectedDate);
                summaryTitle = `สรุปกิจกรรมสำหรับวันที่ ${formatDate(selectedDate)}`;
                periodName = `วันที่ ${selectedDate}`;
            } else if (summaryType === 'date-range') {
                const startDate = summaryStartDateInput.value;
                const endDate = summaryEndDateInput.value;
                if (!startDate || !endDate) {
                    dailySummaryResults.innerHTML = '<p class="error-message">กรุณาเลือกช่วงวันที่ให้ครบถ้วน</p>';
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    dailySummaryResults.innerHTML = '<p class="error-message">วันที่เริ่มต้นต้องไม่เกินวันที่สิ้นสุด</p>';
                    return;
                }
                activitiesToSummarize = userActivities.filter(act => 
                    act.date >= startDate && act.date <= endDate
                );
                summaryTitle = `สรุปกิจกรรมสำหรับช่วงวันที่ ${formatDate(startDate)} ถึง ${formatDate(endDate)}`;
                periodName = `จาก ${startDate} ถึง ${endDate}`;
            } else {
                activitiesToSummarize = userActivities;
                summaryTitle = 'สรุปกิจกรรมทั้งหมดของคุณ';
                periodName = 'ทั้งหมด';
            }

            const activitySummary = {};
            activitiesToSummarize.forEach(activity => {
                const durationMinutes = calculateDuration(activity.startTime, activity.endTime);
                if (activitySummary[activity.activityName]) {
                    activitySummary[activity.activityName] += durationMinutes;
                } else {
                    activitySummary[activity.activityName] = durationMinutes;
                }
                totalOverallMinutes += durationMinutes;
            });

            summaryContext = {
                summaryResult: {
                    summary: activitySummary,
                    totalMinutes: totalOverallMinutes,
                    activities: activitiesToSummarize
                },
                title: summaryTitle,
                periodName: periodName,
                summaryType: summaryType
            };

            // เปิด modal เลือกรูปแบบการแสดงผล
            openSummaryOutputModal();
        };

        updateSummaryInputsVisibility();
    }

    // ========== Admin Functions ==========
    function setupAdminHandlers() {
        const userListTableBody = document.querySelector('#user-list-table tbody');
        const allActivitiesTableBody = document.querySelector('#all-activities-table tbody');

        const adminSearchUserInput = document.getElementById('admin-search-user');
        const adminFilterDateInput = document.getElementById('admin-filter-date');
        const adminFilterActivityTypeSelect = document.getElementById('admin-filter-activity-type');
        const adminApplyFilterButton = document.getElementById('admin-apply-filter-button');
        const adminResetFilterButton = document.getElementById('admin-reset-filter-button');
        
        const adminAddUserForm = document.getElementById('admin-add-user-form');
        const adminAddUserMessage = document.getElementById('admin-add-user-message');
        
        const editUserModal = document.getElementById('edit-user-modal');
        const editUserForm = document.getElementById('edit-user-form');
        const editUserMessage = document.getElementById('edit-user-message');

        const exportDataButton = document.getElementById('export-data-button');
        const showImportButton = document.getElementById('show-import-button');
        const importDataInput = document.getElementById('import-data-input');
        const importExportMessage = document.getElementById('import-export-message');

        populateActivityTypeDropdowns('admin-filter-activity-type');

        function displayUsers(usersToDisplay) {
            userListTableBody.innerHTML = '';
            usersToDisplay.forEach(user => {
                const row = userListTableBody.insertRow();
                row.insertCell().textContent = user.id;
                row.insertCell().textContent = user.username;
                row.insertCell().textContent = user.role;
                
                const actionsCell = row.insertCell();
                const editButton = document.createElement('button');
                editButton.textContent = 'แก้ไข';
                editButton.className = 'action-buttons';
                editButton.onclick = () => editUser(user.id);
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'ลบ';
                deleteButton.className = 'action-buttons delete-button';
                deleteButton.onclick = () => deleteUser(user.id);
                actionsCell.appendChild(deleteButton);
            });
        }

        function displayAllActivities(activitiesToDisplay) {
            allActivitiesTableBody.innerHTML = '';
            const users = getFromLocalStorage('users');

            activitiesToDisplay.forEach(activity => {
                const row = allActivitiesTableBody.insertRow();
                const user = users.find(u => u.id === activity.userId);
                const username = user ? user.username : 'Unknown';
                const durationMinutes = calculateDuration(activity.startTime, activity.endTime);

                row.insertCell().textContent = username;
                row.insertCell().textContent = activity.activityName;
                row.insertCell().textContent = formatDate(activity.date);
                row.insertCell().textContent = activity.startTime;
                row.insertCell().textContent = activity.endTime;
                row.insertCell().textContent = formatDuration(durationMinutes);
                const actionsCell = row.insertCell();
                actionsCell.textContent = '---';
            });
        }

        adminAddUserForm.onsubmit = (e) => {
            e.preventDefault();
            const username = document.getElementById('admin-add-username').value;
            const password = document.getElementById('admin-add-password').value;
            const confirmPassword = document.getElementById('admin-add-confirm-password').value;
            const role = document.getElementById('admin-add-role').value;
            
            let users = getFromLocalStorage('users');

            if (password !== confirmPassword) {
                adminAddUserMessage.textContent = 'รหัสผ่านและยืนยันรหัสผ่านไม่ตรงกัน';
                return;
            }

            if (users.some(u => u.username === username)) {
                adminAddUserMessage.textContent = 'ชื่อผู้ใช้งานนี้มีอยู่แล้ว';
                return;
            }

            const hashedPassword = hashPassword(password);

            const newUser = {
                id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
                username: username,
                password: hashedPassword,
                role: role
            };

            users.push(newUser);
            saveToLocalStorage('users', users);
            adminAddUserMessage.textContent = 'เพิ่มผู้ใช้งานสำเร็จ!';
            adminAddUserMessage.style.color = 'green';
            adminAddUserForm.reset();
            displayUsers(users);
            
            setTimeout(() => adminAddUserMessage.textContent = '', 3000);
        };

        function editUser(userId) {
            const users = getFromLocalStorage('users');
            const userToEdit = users.find(u => u.id === userId);
            
            if (userToEdit) {
                document.getElementById('edit-user-id').value = userToEdit.id;
                document.getElementById('edit-user-username').value = userToEdit.username;
                document.getElementById('edit-user-role').value = userToEdit.role;
                document.getElementById('edit-user-password').value = '';
                
                editUserMessage.textContent = '';
                editUserModal.style.display = 'flex';
            }
        }

        editUserForm.onsubmit = (e) => {
            e.preventDefault();
            const userId = parseInt(document.getElementById('edit-user-id').value);
            const username = document.getElementById('edit-user-username').value;
            const password = document.getElementById('edit-user-password').value;
            const role = document.getElementById('edit-user-role').value;
            
            let users = getFromLocalStorage('users');
            const userIndex = users.findIndex(u => u.id === userId);
            
            if (userIndex === -1) {
                editUserMessage.textContent = 'ไม่พบผู้ใช้งานนี้';
                return;
            }

            if (users.some(u => u.username === username && u.id !== userId)) {
                editUserMessage.textContent = 'ชื่อผู้ใช้งานนี้มีอยู่แล้ว';
                return;
            }

            users[userIndex].username = username;
            users[userIndex].role = role;
            
            if (password) {
                const hashedPassword = hashPassword(password);
                users[userIndex].password = hashedPassword;
            }

            saveToLocalStorage('users', users);
            editUserMessage.textContent = 'อัปเดตผู้ใช้งานสำเร็จ!';
            editUserMessage.style.color = 'green';
            displayUsers(users);
            
            setTimeout(() => {
                editUserModal.style.display = 'none';
                editUserMessage.textContent = '';
            }, 2000);
        };

        function deleteUser(userId) {
            if (confirm('คุณแน่ใจหรือไม่ที่จะลบผู้ใช้งานนี้? การลบผู้ใช้จะลบกิจกรรมทั้งหมดของผู้ใช้ด้วย')) {
                let users = getFromLocalStorage('users');
                let activities = getFromLocalStorage('activities');
                
                users = users.filter(u => u.id !== userId);
                activities = activities.filter(a => a.userId !== userId);
                
                saveToLocalStorage('users', users);
                saveToLocalStorage('activities', activities);
                
                displayUsers(users);
                displayAllActivities(activities);
                
                alert('ลบผู้ใช้งานสำเร็จ');
            }
        }

        exportDataButton.onclick = () => {
            const data = {
                users: getFromLocalStorage('users'),
                activities: getFromLocalStorage('activities'),
                activityTypes: getFromLocalStorage('activityTypes')
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `activity_tracker_data_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            importExportMessage.textContent = 'ข้อมูลถูกบันทึกเป็นไฟล์ JSON แล้ว';
            importExportMessage.style.color = 'green';
            setTimeout(() => importExportMessage.textContent = '', 3000);
        };

        showImportButton.onclick = () => {
            importDataInput.click();
        };

        importDataInput.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.users && importedData.activities && importedData.activityTypes) {
                        if (confirm('การนำเข้าข้อมูลจะเขียนทับข้อมูลที่มีอยู่ทั้งหมด คุณแน่ใจหรือไม่?')) {
                            saveToLocalStorage('users', importedData.users);
                            saveToLocalStorage('activities', importedData.activities);
                            saveToLocalStorage('activityTypes', importedData.activityTypes);
                            importExportMessage.textContent = 'นำเข้าข้อมูลสำเร็จแล้ว! กรุณาเข้าสู่ระบบอีกครั้ง';
                            importExportMessage.style.color = 'green';
                            clearLoggedInUser();
                            setTimeout(() => window.location.reload(), 2000);
                        }
                    } else {
                        throw new Error('โครงสร้างไฟล์ JSON ไม่ถูกต้อง');
                    }
                } catch (error) {
                    importExportMessage.textContent = `ข้อผิดพลาดในการนำเข้า: ${error.message}`;
                    importExportMessage.style.color = 'red';
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        };

        function loadAdminDashboardData() {
            const users = getFromLocalStorage('users');
            const activities = getFromLocalStorage('activities');

            displayUsers(users);
            displayAllActivities(activities);
        }

        adminApplyFilterButton.addEventListener('click', () => {
            const searchTerm = adminSearchUserInput.value.toLowerCase();
            const filterDate = adminFilterDateInput.value;
            const filterActivityType = adminFilterActivityTypeSelect.value;

            let allActivities = getFromLocalStorage('activities');
            const users = getFromLocalStorage('users');

            let filteredActivities = allActivities;

            if (searchTerm) {
                filteredActivities = filteredActivities.filter(activity => {
                    const user = users.find(u => u.id === activity.userId);
                    return user && user.username.toLowerCase().includes(searchTerm);
                });
            }
            if (filterDate) {
                filteredActivities = filteredActivities.filter(act => act.date === filterDate);
            }
            if (filterActivityType) {
                filteredActivities = filteredActivities.filter(act => act.activityName === filterActivityType);
            }

            displayAllActivities(filteredActivities);
        });

        adminResetFilterButton.onclick = () => {
            adminSearchUserInput.value = '';
            adminFilterDateInput.value = '';
            adminFilterActivityTypeSelect.value = '';
            loadAdminDashboardData();
        };

        loadAdminDashboardData();
    }

    // ========== Navigation Handlers ==========
    function setupNavigationHandlers() {
        document.addEventListener('click', function(e) {
            if (e.target.matches('#main-nav a')) {
                e.preventDefault();
                const page = e.target.getAttribute('data-page');
                console.log('คลิกที่ลิงก์:', page);
                showPage(page);
            }
            
            if (e.target.matches('#logout-button')) {
                e.preventDefault();
                clearLoggedInUser();
                alert('ออกจากระบบสำเร็จ');
                showPage('auth');
            }
        });

        document.querySelectorAll('#main-nav a').forEach(link => {
            const newLink = link.cloneNode(true);
            link.parentNode.replaceChild(newLink, link);
            
            newLink.addEventListener('click', function(e) {
                e.preventDefault();
                const page = this.getAttribute('data-page');
                console.log('คลิกที่ลิงก์ (วิธีที่ 2):', page);
                showPage(page);
            });
        });

        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', function(e) {
                e.preventDefault();
                clearLoggedInUser();
                alert('ออกจากระบบสำเร็จ');
                showPage('auth');
            });
        }
    }

    // ========== Initialize Application ==========
    function initializeApp() {
        console.log('เริ่มต้นแอปพลิเคชัน');
        
        if (getFromLocalStorage('activityTypes').length === 0) {
            saveToLocalStorage('activityTypes', [
                {id: 1, name: 'ทำงาน'},
                {id: 2, name: 'เรียน'},
                {id: 3, name: 'ออกกำลังกาย'},
                {id: 4, name: 'พักผ่อน'},
                {id: 5, name: 'เดินทาง'}
            ]);
        }
        
        if (getFromLocalStorage('users').length === 0) {
            const hashedPassword = hashPassword('admin123');
            saveToLocalStorage('users', [
                {id: 1, username: 'admin', password: hashedPassword, role: 'admin'}
            ]);
            console.log('สร้างผู้ใช้ admin เรียบร้อยแล้ว');
        }

        setupPasswordToggles();
        setupModalHandlers();
        setupNavigationHandlers();
        
        const loggedInUser = getLoggedInUser();
        if (loggedInUser) {
            console.log('ผู้ใช้ล็อกอินอยู่:', loggedInUser.username);
            showPage('activity');
        } else {
            console.log('ไม่มีผู้ใช้ล็อกอิน');
            showPage('auth');
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }
</script>
</body>
</html>
